<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time ESP32 Dashboard</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        // !!! IMPORTANT: The values below MUST be replaced with your actual keys from Firebase Project Settings !!!
        const firebaseConfig = {
          apiKey: "AIzaSyAQmL_8cxdWiC920C-GnrV6GS4S_wBV5y0", // ⬅️ REPLACE THIS API KEY
          authDomain: "esp32-weather-dashboard.firebaseapp.com",
          projectId: "esp32-weather-dashboard", // ⬅️ REPLACE THIS PROJECT ID (ONLY IF DIFFERENT)
          storageBucket: "esp32-weather-dashboard.firebasestorage.app",
          messagingSenderId: "846543764599",
          appId: "1:846543764599:web:de34bec4b89969043cda72"
        };

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- CORE APPLICATION LOGIC ---

        const TEMP_ID = 'temp-value';
        const TIME_ID = 'time-value';
        const LOADING_ID = 'loading-state';

        // Path to the document written by the ESP32 (MUST match the C++ code)
        const DOC_PATH = "artifacts/default-app-id/public/data/weatherData/current_readings";
        
        // Function to update the HTML with new data
        function updateDashboard(data) {
            document.getElementById(TEMP_ID).textContent = `${data.temperature || '--'}°C`;
            document.getElementById(TIME_ID).textContent = `Last Updated: ${data.timestamp || 'Waiting for device...'}`;
            document.getElementById(LOADING_ID).classList.add('hidden'); // Hide loading message
        }

        async function startRealTimeListener() {
            try {
                // 1. Authenticate Anonymously (Satisfies the secure database rule)
                // This is the line that requires the correct apiKey and authDomain
                await signInAnonymously(auth); 
                console.log("Signed in anonymously. Starting listener...");
                
                // 2. Set up the Real-Time Listener
                onSnapshot(doc(db, DOC_PATH), (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        console.log("New data received:", data);
                        // The core function: update the UI immediately
                        updateDashboard(data); 
                    } else {
                        console.log("No document found at path:", DOC_PATH);
                        // Show initial waiting state if the document is empty
                        document.getElementById(LOADING_ID).textContent = "Waiting for ESP32 to send first reading...";
                    }
                }, (error) => {
                    console.error("Firestore Listener Error:", error);
                    document.getElementById(LOADING_ID).textContent = `ERROR: Firestore Listener failed (${error.code}).`;
                });

            } catch (error) {
                // This catches the 'auth/configuration-not-found' error specifically
                console.error("Authentication or Initialization Error:", error);
                document.getElementById(LOADING_ID).textContent = `CRITICAL ERROR: ${error.code}. Ensure your Firebase configuration is correct and that Auth is enabled in your project.`;
            }
        }

        // Start the application when the page loads
        startRealTimeListener();

    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gray-100 font-sans">
    <div class="w-full max-w-sm bg-white shadow-lg rounded-xl p-6 text-center">
        
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Live Weather Readings</h1>

        <!-- Loading State/Error Message -->
        <p id="loading-state" class="text-sm text-blue-600 mb-4">Connecting to Firebase...</p>

        <!-- Temperature Display -->
        <div class="bg-blue-600 text-white p-6 rounded-lg shadow-md mb-4">
            <p class="text-lg font-medium opacity-90">Current Temperature</p>
            <p id="temp-value" class="text-6xl font-extrabold mt-1">--°C</p>
        </div>

        <!-- Last Updated Time -->
        <p id="time-value" class="text-sm text-gray-500 mt-4">Last Updated: N/A</p>

    </div>
</body>
</html>
